<% if Current.user %>
  <div class="container mt-5">
    <!-- Post Creation Form Section -->
    <div class="card p-4 shadow border-light" style="max-width: 800px; margin: 0 auto;">
      <h3 class="text-center mb-4 text-primary">Create a New Post</h3>
      <%= form_with model: @post, url: blog_posts_path do |form| %>
        <div class="mb-3">
          <%= form.label :title, class: "form-label" %>
          <%= form.text_field :title, class: "form-control", placeholder: "Enter title" %>
        </div>

        <div class="mb-3">
          <%= form.label :body, class: "form-label" %>
          <%= form.text_area :body, class: "form-control", placeholder: "Tell the world about your story", rows: 5 %>
        </div>

        <div class="mb-3">
          <%= form.label :scheduled_time, "Schedule Post (optional)", class: "form-label" %>
          <%= form.datetime_local_field :scheduled_time, class: "form-control" %>
        </div>

        <div class="text-center">
          <%= form.submit "Post", class: "btn btn-primary btn-lg" %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<!-- Blog Posts Section -->
<div class="container mt-5">
  <h1 class="text-center mb-4 text-info">Recent Blog Posts</h1>
  <div class="row justify-content-center">
    <% @blog_posts.each do |blog_post| %>
      <div class="col-md-12 mb-4">
        <div class="card shadow border-0" style="border-radius: 15px;">
          <div class="card-body">
            <h2 class="card-title text-center mb-3 fw-bold text-dark"> <%= blog_post.title %> </h2>
            <div class="post-body bg-light p-4 rounded-3" style="max-height: 200px; overflow-y: auto;">
              <p class="card-text lead text-secondary"> <%= blog_post.body %> </p>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-between align-items-center bg-white border-top">
            <%= render 'like_button', blog_post: blog_post %>
            <button class="btn btn-link text-secondary border-0 p-0" data-bs-toggle="modal" data-bs-target="#commentsModal<%= blog_post.id %>">
              <i class="far fa-comments me-1"></i>Comments (<%= blog_post.comments.count %>)
            </button>
            <small class="text-secondary"><i class="far fa-user me-1"></i><%= blog_post.user.name %></small>
          </div>
          
          <!-- Comments Modal -->
          <div class="modal fade" id="commentsModal<%= blog_post.id %>" tabindex="-1" aria-labelledby="commentsModalLabel<%= blog_post.id %>" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <div class="modal-header border-0">
                  <h5 class="modal-title" id="commentsModalLabel<%= blog_post.id %>">
                    Comments on "<%= blog_post.title %>"
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Display existing comments -->
                  <div class="comments-list mb-3">
                    <% if blog_post.comments.any? %>
                      <% blog_post.comments.each do |comment| %>
                        <div class="comment mb-3 p-3 bg-light rounded">
                          <div class="d-flex justify-content-between align-items-center mb-2">
                            <strong class="text-dark"><i class="far fa-user-circle me-1"></i><%= comment.author_name %></strong>
                            <small class="text-muted"><i class="far fa-clock me-1"></i><%= time_ago_in_words(comment.created_at) %> ago</small>
                          </div>
                          <p class="mb-2 text-dark"><%= comment.content %></p>
                          <% if Current.user && Current.user.name == comment.author_name %>
                            <%= button_to blog_post_comment_path(blog_post, comment),
                                method: :delete,
                                class: 'btn btn-link text-danger p-0 border-0',
                                form: { style: 'display: inline-block' },
                                data: { confirm: 'Are you sure?' } do %>
                                <i class="far fa-trash-alt me-1"></i>Delete
                            <% end %>
                          <% end %>
                        </div>
                      <% end %>
                    <% else %>
                      <p class="text-muted text-center">No comments yet. Be the first to comment!</p>
                    <% end %>
                  </div>

                  <!-- Comment form -->
                  <% if Current.user %>
                    <%= form_with(model: [blog_post, Comment.new], local: true, class: 'mt-4') do |f| %>
                      <%= f.hidden_field :author_name, value: Current.user.name %>
                      <div class="form-group">
                        <%= f.text_area :content, class: 'form-control mb-2', 
                            placeholder: 'Share your thoughts...', rows: 3 %>
                      </div>
                      <%= f.submit 'Post Comment', class: 'btn btn-primary rounded-pill px-4' %>
                    <% end %>
                  <% else %>
                    <p class="text-muted text-center">
                      Please <%= link_to "sign in", sign_in_path, class: "text-primary text-decoration-none fw-bold hover-underline" %> to comment.
                    </p>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>